<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<style> circle {fill: lightblue; stroke: black;} </style>
<body onload='init()'>
<svg width=650 height=300>
</svg>
<div id ="tooltip" opacity =0 ></div>

<label for="input year">Year</label>
  <select id="select_year" name="select_year">
    <option value="All"></option>
    <option value="2019">2019</option>
    <option value="2020">2020</option>
    <option value="2021">2021</option>
    <option value="2022">2022</option>
  </select>

<label for="input county">County</label>
  <select id="select_cnty" name="select_cnty">
    <option value="None"></option>
    <option value="Alameda">Alameda</option>
    <option value="Contra Costa">Contra Costa</option>
    <option value="San Francisco">San Francisco</option>
    <option value="San Mateo">San Mateo</option>
    <option value="Santa Clara">Santa Clara</option>
   </select>
   <button id="All Counties">
   All Counties
   </button>
<script>
async function init() {
      const data = await d3.csv(
    'https://raw.githubusercontent.com/katldewitt/data_viz_covid_bart/feat/vis-narrative/User_Created_Data/103_monthly_ridership_data.csv');
 
  var y = d3.scaleLinear()
            .domain([0, 9550000]) //TODO: adjust max dynamically?
            .range([200, 0]);

  //Source: Working with dates in D3 js https://stackoverflow.com/questions/8301531/dealing-with-dates-on-d3-js-axis
  function getDate(d) {
    return new Date(d.date);
  }
  var x = d3.scaleTime()
              .domain([new Date("1/1/2019"), new Date("5/2/2022")])
              .range([0, 600]);

  var x_axis = d3.axisBottom()

   .scale(x).ticks(d3.timeMonth, 1).tickFormat(d3.timeFormat('%b-%Y'));
  var y_axis = d3.axisLeft()
   .scale(y).tickFormat(d3.format("~s"));

   var tooltip = d3.select("#tooltip");


  
//TODO: Filter data by year
//************************* Begin: Filter by year
var year_html = document.getElementById('select_year');
year_html.addEventListener("change", onYearChange);

function onYearChange(){
  var selectedYear = d3.select(this).property("value");
  var selectedCnty = d3.select(cnty).property("value");
  //This makes only the relevant county data appear
  circles.transition()
    .duration(1000)
    .style("opacity", function(d) {
      if (selectedCnty == "None") {
        return d.year == selectedYear ? 1 : 0;
      }
      return d.year == selectedYear && d.station_cnty == selectedCnty ? 1 : 0;
    }) 
}
//************************* End: Filter by year

//************************* Begin: Filter by county
var cnty = document.getElementById('select_cnty');
cnty.addEventListener("change", onCntyChange);

var allCntyButton = document.getElementById('All Counties');
allCntyButton.addEventListener("click", showAllCnty)

function onCntyChange(){
  var selectedCnty = d3.select(this).property("value");
  var selectedYear = d3.select(year_html).property("value");
  //This makes only the relevant county data appear
  circles.transition()
    .duration(1000)
    .style("opacity", function(d) {
      if (selectedYear == "All") {
        return  d.station_cnty == selectedCnty  ? 1 : 0;
      }
      return d.year == selectedYear && d.station_cnty == selectedCnty ? 1 : 0;
    }) 
}
function showAllCnty(){
  circles.transition()
    .duration(1000)
    .style("opacity", 1);
}
//https://stackoverflow.com/questions/39964570/how-to-filter-data-with-d3-js
//************************* End: Filter by county



//TODO:anotations and affordances

var mouseover = function(d,i) {
    tooltip.style("opacity",1)
        .attr("class", "tooltip")
        .style("background-color", "white")
        .style("border", "solid")
        .style("border-width", "2px")
        .style("border-radius", "5px")
        .style("padding", "5px")
      .style("left", (d3.mouse(this)[0]+70) + "px")
      .style("top", (d3.mouse(this)[1]) + "px")
    d3.select(this)
      .style("stroke", "black")
      .style("opacity", 1)
  }
  var mousemove = function(d,i) {
    tooltip
        .html("Item # "+i+"is "+d.station_cnty +  " " + d.date + " " +d3.mouse(this)[0] +" " +d3.mouse(this)[1] )
        .attr("class", "tooltip")
        .style("background-color", "white")
        .style("border", "solid")
        .style("border-width", "2px")
        .style("border-radius", "5px")
        .style("padding", "5px")

        .style("left", (event.pageX)+ "px")
      .style("top", (event.pageY) + "px");
  }
  var mouseleave = function(d,i) {
    tooltip
      .style("opacity", 0)
  }

  //Group lines by color
  var allGroup = ["Alameda", "Contra Costa", "San Francisco", "San Mateo", "Santa Clara"]
  var myColor = d3.scaleOrdinal()
      .domain(allGroup)
      .range(d3.schemeSet2);

  var svg =  d3.select("svg").append("g").attr("transform", "translate(50,50)");

  var circles = svg
    .selectAll("circle")
    .data(data)
    .enter()
    .append("circle")
    .attr("cx",function(d,i){ return  x(getDate(d));})
    .attr("cy",function(d,i){ return y(Number(d.cnt_riders));})
    .attr("r",function(d,i){ return 4;})
    .style("fill",  function(d){ return myColor(d.station_cnty) })
    .style("stroke",  function(d){ return myColor(d.station_cnty) })
    .on("mouseover", mouseover)
    .on("mousemove", mousemove)
    .on("mouseleave", mouseleave);

    
  //TODO: get scatter plot working https://d3-graph-gallery.com/graph/connectedscatter_multi.html
    var line = d3.line()
      .x(function(d) { return x(+getDate(d)) })
      .y(function(d) { return y(+Number(d.cnt_exits)) });
    svg.attr("transform", "translate(50,50)")
      .data(data)
      .enter()
      .append("path")
        .attr("d", function(d){ return line(d) } )
        .attr("stroke", function(d){ return myColor(d.station_cnty) })
        .style("stroke-width", 4)
        .style("fill", "none")


    d3.select("svg").append("g").attr("transform", "translate(50,50)")
     .call(y_axis);

     d3.select("svg").append("g").attr("transform", "translate(50,250)")
     .call(x_axis)
     .selectAll("text")  
      .style("text-anchor", "end")
      .attr("dx", "-.9em")
      .attr("dy", ".15em")
      .attr("transform", "rotate(-90)");


}
</script>
<p>EXAMPLE https://github.com/mbtaviz/mbtaviz.github.io/</p>


</body>
</html>